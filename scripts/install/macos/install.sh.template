#!/bin/bash

# ostruct macOS Installation Script
# This script sets up ostruct on macOS with proper Python and PATH configuration
# Usage: curl -sSL https://github.com/yaniv-golan/ostruct/releases/latest/download/install-macos.sh | bash

set -e  # Exit on any error

# Version information (automatically updated during build)
EXPECTED_VERSION="{{OSTRUCT_VERSION}}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Detect shell
detect_shell() {
    if [[ -n "$ZSH_VERSION" ]]; then
        echo "zsh"
    elif [[ -n "$BASH_VERSION" ]]; then
        echo "bash"
    else
        echo "unknown"
    fi
}

# Get shell config file
get_shell_config() {
    local shell_type="$1"
    case "$shell_type" in
        "zsh")
            echo "$HOME/.zshrc"
            ;;
        "bash")
            if [[ -f "$HOME/.bash_profile" ]]; then
                echo "$HOME/.bash_profile"
            else
                echo "$HOME/.bashrc"
            fi
            ;;
        *)
            echo "$HOME/.profile"
            ;;
    esac
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if Python version is compatible
check_python_version() {
    local python_cmd="$1"
    local version_output

    if ! version_output=$($python_cmd --version 2>&1); then
        return 1
    fi

    # Extract version number (e.g., "Python 3.10.2" -> "3.10.2")
    local version=$(echo "$version_output" | sed 's/Python //')
    local major=$(echo "$version" | cut -d. -f1)
    local minor=$(echo "$version" | cut -d. -f2)

    # Check if version >= 3.10
    if [[ "$major" -gt 3 ]] || [[ "$major" -eq 3 && "$minor" -ge 10 ]]; then
        return 0
    else
        return 1
    fi
}

# Find compatible Python installation
find_python() {
    local python_candidates=("python3.12" "python3.11" "python3.10" "python3" "python")

    for cmd in "${python_candidates[@]}"; do
        if command_exists "$cmd" && check_python_version "$cmd"; then
            echo "$cmd"
            return 0
        fi
    done

    return 1
}

# Install Homebrew
install_homebrew() {
    log_info "Installing Homebrew..."
    log_warning "Homebrew installation may require Xcode Command Line Tools"
    log_info "You may be prompted for your password and to install developer tools"
    log_info "This is normal and required for Homebrew to function properly"

    if ! /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; then
        log_error "Failed to install Homebrew"
        exit 1
    fi

    # Add Homebrew to PATH for current session
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        # Apple Silicon
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        # Intel
        eval "$(/usr/local/bin/brew shellenv)"
    fi

    log_success "Homebrew installed successfully"
}

# Install Python via Homebrew
install_python_homebrew() {
    log_info "Installing Python via Homebrew..."

    if ! command_exists brew; then
        install_homebrew
    fi

    log_info "Updating Homebrew package information..."
    if ! brew update; then
        log_warning "Failed to update Homebrew, continuing with cached package info..."
    fi

    if ! brew install python@3.12; then
        log_error "Failed to install Python via Homebrew"
        exit 1
    fi

    log_success "Python installed via Homebrew"
}

# Install Python from python.org
install_python_official() {
    log_info "Installing Python from python.org..."
    log_info "Fetching latest Python version information..."

    # Get latest Python version dynamically
    local python_version
    if python_version=$(curl -s 'https://endoflife.date/api/v1/products/python/releases/latest' | \
        grep -o '"latest":{"name":"[^"]*"' | \
        cut -d'"' -f6); then
        log_info "Found latest Python version: $python_version"
    else
        log_warning "Failed to fetch latest version, falling back to Python 3.12.0"
        python_version="3.12.0"
    fi

    # Detect architecture
    local arch=$(uname -m)
    local installer_url

    # Modern Python versions use universal2 installers that support both Intel and Apple Silicon
    installer_url="https://www.python.org/ftp/python/${python_version}/python-${python_version}-macos11.pkg"

    local temp_file="/tmp/python-installer.pkg"

    log_info "Downloading Python $python_version installer..."
    if ! curl -L -o "$temp_file" "$installer_url"; then
        log_error "Failed to download Python installer from $installer_url"
        log_error "The installer URL may be outdated. Please visit https://www.python.org/downloads/macos/ to download manually."
        exit 1
    fi

    log_info "Installing Python (requires admin privileges)..."
    if ! sudo installer -pkg "$temp_file" -target /; then
        log_error "Failed to install Python"
        exit 1
    fi

    # Clean up
    rm -f "$temp_file"

    log_success "Python $python_version installed from python.org"
}

# Get Python user bin directory
get_python_user_bin() {
    local python_cmd="$1"
    local user_base

    if ! user_base=$($python_cmd -m site --user-base 2>/dev/null); then
        return 1
    fi

    echo "$user_base/bin"
}

# Add directory to PATH in shell config
add_to_path() {
    local dir_to_add="$1"
    local shell_config="$2"
    local shell_type="$3"

    # Check if already in PATH
    if echo "$PATH" | grep -q "$dir_to_add"; then
        log_info "Directory $dir_to_add already in PATH"
        return 0
    fi

    # Check if already in shell config
    if [[ -f "$shell_config" ]] && grep -q "$dir_to_add" "$shell_config"; then
        log_info "Directory $dir_to_add already configured in $shell_config"
        return 0
    fi

    # Add to shell config
    local export_line="export PATH=\"$dir_to_add:\$PATH\""
    echo "" >> "$shell_config"
    echo "# Added by ostruct installer" >> "$shell_config"
    echo "$export_line" >> "$shell_config"

    # Add to current session
    export PATH="$dir_to_add:$PATH"

    log_success "Added $dir_to_add to PATH in $shell_config"
}

# Update PATH immediately for current session
update_current_path() {
    local dir_to_add="$1"
    if ! echo "$PATH" | grep -q "$dir_to_add"; then
        export PATH="$dir_to_add:$PATH"
        log_info "Updated PATH for current session: $dir_to_add"
    fi
}

# Clean up conflicting Python installations from PATH
cleanup_old_python_paths() {
    local python_cmd="$1"
    local current_python_bin

    # Get the directory of the Python we want to use
    current_python_bin=$(dirname "$(which "$python_cmd" 2>/dev/null)")

    if [[ -n "$current_python_bin" ]]; then
        log_info "Prioritizing Python installation at: $current_python_bin"
        # Move current Python to front of PATH
        export PATH="$current_python_bin:$(echo "$PATH" | sed "s|$current_python_bin:||g")"
    fi
}

# Compare version strings (returns 0 if v1 >= v2)
version_compare() {
    local v1="$1"
    local v2="$2"

    # Extract just the version numbers (handle multiple formats)
    # "ostruct, version 0.8.8" -> "0.8.8"
    # "ostruct-cli 0.8.8" -> "0.8.8"
    # "0.8.8" -> "0.8.8"
    v1=$(echo "$v1" | sed -E 's/.*(version |ostruct-cli |ostruct |^)([0-9]+\.[0-9]+\.[0-9]+).*/\2/')
    v2=$(echo "$v2" | sed -E 's/.*(version |ostruct-cli |ostruct |^)([0-9]+\.[0-9]+\.[0-9]+).*/\2/')

    # Use sort -V for version comparison
    if [[ "$(printf '%s\n' "$v1" "$v2" | sort -V | head -n1)" == "$v2" ]]; then
        return 0  # v1 >= v2
    else
        return 1  # v1 < v2
    fi
}

# Detect all ostruct installations with metadata
detect_ostruct_installations() {
    local installations=()

    # Search common installation locations
    local search_paths=(
        "$HOME/.local/bin"
        "$HOME/Library/Python/*/bin"
        "/usr/local/bin"
        "/opt/homebrew/bin"
    )

    for search_pattern in "${search_paths[@]}"; do
        for search_dir in $search_pattern; do
            if [[ -f "$search_dir/ostruct" ]]; then
                local install_info=""
                local version=""
                local install_method=""

                # Try to get version
                if version=$("$search_dir/ostruct" --version 2>/dev/null); then
                    version=$(echo "$version" | sed -E 's/.*(version |ostruct-cli |ostruct |^)([0-9]+\.[0-9]+\.[0-9]+).*/\2/')
                else
                    version="unknown"
                fi

                # Determine installation method based on path
                if [[ "$search_dir" == "$HOME/.local/bin" ]]; then
                    install_method="pipx"
                elif [[ "$search_dir" == "$HOME/Library/Python/"*"/bin" ]]; then
                    local python_version=$(echo "$search_dir" | sed -E 's|.*/Python/([0-9.]+)/bin|\1|')
                    install_method="pip-user (Python $python_version)"
                elif [[ "$search_dir" == "/usr/local/bin" ]] || [[ "$search_dir" == "/opt/homebrew/bin" ]]; then
                    install_method="system/homebrew"
                else
                    install_method="unknown"
                fi

                install_info="$search_dir/ostruct|$version|$install_method"
                installations+=("$install_info")
            fi
        done
    done

    printf '%s\n' "${installations[@]}"
}

# Remove an ostruct installation safely
remove_ostruct_installation() {
    local install_path="$1"
    local install_method="$2"
    local dry_run="${3:-false}"

    if [[ "$dry_run" == "true" ]]; then
        log_info "[DRY-RUN] Would remove: $install_path"
        return 0
    fi

    local install_dir=$(dirname "$install_path")

    if [[ "$install_method" == "pipx" ]]; then
        # Use pipx to remove cleanly
        if command_exists pipx; then
            log_info "Removing ostruct via pipx..."
            if pipx uninstall ostruct-cli; then
                log_success "Removed ostruct via pipx"
                return 0
            else
                log_warning "pipx uninstall failed, falling back to manual removal"
            fi
        fi
    elif [[ "$install_method" == pip-user* ]]; then
        # Extract Python version from method string
        local python_version=$(echo "$install_method" | sed -E 's/pip-user \(Python ([0-9.]+)\)/\1/')
        local python_cmd="python$python_version"

        # Try to find the exact Python command
        if ! command_exists "$python_cmd"; then
            python_cmd="python3"
        fi

        if command_exists "$python_cmd"; then
            log_info "Removing ostruct via pip (Python $python_version)..."
            if "$python_cmd" -m pip uninstall -y ostruct-cli; then
                log_success "Removed ostruct via pip"
                return 0
            else
                log_warning "pip uninstall failed, falling back to manual removal"
            fi
        fi
    fi

    # Manual removal as fallback
    log_info "Manually removing ostruct binary: $install_path"
    if rm -f "$install_path"; then
        log_success "Manually removed: $install_path"
        return 0
    else
        log_error "Failed to remove: $install_path"
        return 1
    fi
}

# Interactive cleanup of old installations
cleanup_old_installations() {
    local current_install_path="$1"
    local dry_run="${2:-false}"

    log_info "Scanning for existing ostruct installations..."

    local installations=()
    while IFS= read -r line; do
        installations+=("$line")
    done < <(detect_ostruct_installations)

    if [[ ${#installations[@]} -le 1 ]]; then
        log_info "No conflicting installations found"
        return 0
    fi

    echo ""
    log_warning "Multiple ostruct installations detected:"
    echo ""

    local current_version=""
    local removal_candidates=()

    # Display all installations
    local index=1
    for install_info in "${installations[@]}"; do
        IFS='|' read -r path version method <<< "$install_info"

        if [[ "$path" == "$current_install_path" ]]; then
            echo "  $index. $path (v$version) [$method] â† CURRENT INSTALLATION"
            current_version="$version"
        else
            echo "  $index. $path (v$version) [$method]"
            removal_candidates+=("$install_info")
        fi
        ((index++))
    done

    if [[ ${#removal_candidates[@]} -eq 0 ]]; then
        log_info "No old installations to remove"
        return 0
    fi

    echo ""

    if [[ "$dry_run" == "true" ]]; then
        log_info "[DRY-RUN] Would offer to remove ${#removal_candidates[@]} old installation(s)"
        return 0
    fi

    # Ask user if they want to remove old installations
    log_warning "Old installations may cause conflicts and import errors."
    log_info "The following installations will be removed:"

    for install_info in "${removal_candidates[@]}"; do
        IFS='|' read -r path version method <<< "$install_info"
        echo "  â€¢ $path (v$version) [$method]"
    done

    echo ""
    read -p "Would you like to remove these old installations? (y/N): " -r response

    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        log_info "Keeping old installations. You may need to manage PATH manually."
        log_info "To clean up later, run: curl -sSL https://github.com/yaniv-golan/ostruct/releases/latest/download/install-macos.sh | bash -s -- --cleanup-only"
        return 0
    fi

    echo ""
    log_info "Removing old installations..."

    local removed_count=0
    local failed_count=0

    for install_info in "${removal_candidates[@]}"; do
        IFS='|' read -r path version method <<< "$install_info"

        # Safety check: don't remove the current installation
        if [[ "$path" == "$current_install_path" ]]; then
            log_warning "Skipping $path - this is the current installation"
            continue
        fi

        # Skip if this is a newer version (safety check)
        if [[ "$current_version" != "unknown" && "$version" != "unknown" ]]; then
            if version_compare "$version" "$current_version"; then
                log_warning "Skipping $path (v$version) - newer than current installation"
                continue
            fi
        fi

        if remove_ostruct_installation "$path" "$method" false; then
            ((removed_count++))
        else
            ((failed_count++))
        fi
    done

    echo ""
    if [[ $removed_count -gt 0 ]]; then
        log_success "Successfully removed $removed_count old installation(s)"
    fi

    if [[ $failed_count -gt 0 ]]; then
        log_warning "$failed_count installation(s) could not be removed automatically"
        log_info "You may need to remove them manually or check permissions"
    fi

    return 0
}

# Main installation function
main() {
    # Check for special modes
    local DRY_RUN=false
    local CLEANUP_ONLY=false

    for arg in "$@"; do
        case "$arg" in
            "--dry-run"|"-n")
                DRY_RUN=true
                ;;
            "--cleanup-only"|"-c")
                CLEANUP_ONLY=true
                ;;
            "--help"|"-h")
                echo "ostruct macOS Installation Script"
                echo ""
                echo "Usage: $0 [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --dry-run, -n      Run in dry-run mode (no actual changes)"
                echo "  --cleanup-only, -c Only clean up old installations"
                echo "  --help, -h         Show this help message"
                echo ""
                exit 0
                ;;
        esac
    done

    if [[ "$DRY_RUN" == "true" ]]; then
        log_info "Running in DRY-RUN mode - no actual changes will be made"
        echo ""
    fi

    if [[ "$CLEANUP_ONLY" == "true" ]]; then
        echo "ðŸ§¹ ostruct Cleanup Mode"
        echo "======================"
        echo ""
        log_info "Scanning for ostruct installations to clean up..."

        # Find any ostruct installation to use as reference
        local current_install_path=""
        if command_exists ostruct; then
            current_install_path=$(which ostruct 2>/dev/null)
        else
            # Find the first available installation
            local installations=()
            while IFS= read -r line; do
                installations+=("$line")
            done < <(detect_ostruct_installations)
            if [[ ${#installations[@]} -gt 0 ]]; then
                IFS='|' read -r current_install_path _ _ <<< "${installations[0]}"
            fi
        fi

        if [[ -n "$current_install_path" ]]; then
            cleanup_old_installations "$current_install_path" "$DRY_RUN"
        else
            log_info "No ostruct installations found"
        fi

        echo ""
        log_success "Cleanup complete!"
        exit 0
    fi

    echo "ðŸš€ ostruct macOS Installation Script"
    echo "=================================="
    echo ""

    # Detect shell and config file
    local shell_type=$(detect_shell)
    local shell_config=$(get_shell_config "$shell_type")

    log_info "Detected shell: $shell_type"
    log_info "Shell config file: $shell_config"
    echo ""

    # Check for Python installation
    log_info "Checking Python installation..."
    local python_cmd
    if python_cmd=$(find_python); then
        local python_version=$($python_cmd --version 2>&1)
        log_success "Found compatible $python_version at $(which $python_cmd)"
    else
        log_warning "No compatible Python 3.10+ found"

        if [[ "$DRY_RUN" == "true" ]]; then
            log_info "[DRY-RUN] Would install Python 3.12"
            python_cmd="python3.12"
        else
            # Try Homebrew first, then official installer
            if command_exists brew || [[ -f "/opt/homebrew/bin/brew" ]] || [[ -f "/usr/local/bin/brew" ]]; then
                install_python_homebrew
            else
                log_info "Homebrew not found, using official Python installer"
                install_python_official
            fi

            # Try to find Python again
            if python_cmd=$(find_python); then
                local python_version=$($python_cmd --version 2>&1)
                log_success "Python installation successful: $python_version"
            else
                log_error "Failed to install or find compatible Python"
                exit 1
            fi
        fi
    fi
    echo ""

    # Install ostruct-cli using appropriate method
    log_info "Installing ostruct-cli..."
    local install_method=""

    if [[ "$DRY_RUN" == "true" ]]; then
        log_info "[DRY-RUN] Would try pipx first, then pip with appropriate flags"
        log_success "[DRY-RUN] ostruct-cli installation simulated"
        install_method="dry-run"
    else
        # Try pipx first (recommended for CLI applications)
        if command_exists pipx; then
            log_info "Using pipx for installation..."
            if pipx install ostruct-cli; then
                log_success "ostruct-cli installed successfully with pipx"
                install_method="pipx"
            else
                log_warning "pipx installation failed, trying pip..."
            fi
        else
            # Check if we can install pipx via brew
            if command_exists brew; then
                log_info "Installing pipx via Homebrew..."
                brew update 2>/dev/null || log_warning "Failed to update Homebrew"
                if brew install pipx && pipx install ostruct-cli; then
                    log_success "ostruct-cli installed successfully with pipx"
                    install_method="pipx"
                else
                    log_warning "pipx installation failed, trying pip..."
                fi
            else
                # Try installing pipx via pip as fallback
                log_info "Attempting to install pipx via pip..."
                if $python_cmd -m pip install --user pipx; then
                    # Update PATH immediately so pipx is available
                    local python_user_bin
                    if python_user_bin=$(get_python_user_bin "$python_cmd"); then
                        update_current_path "$python_user_bin"
                    fi

                    # Now try to use pipx
                    if command_exists pipx && pipx install ostruct-cli; then
                        log_success "ostruct-cli installed successfully with pipx"
                        install_method="pipx"
                    else
                        log_warning "pipx installation failed, trying pip..."
                    fi
                else
                    log_warning "pipx installation failed, trying pip..."
                fi
            fi
        fi

        # If pipx didn't work, try pip with appropriate flags
        if [[ -z "$install_method" ]]; then
            log_info "Falling back to pip installation..."

            # Clear cache first
            log_info "Clearing pip cache to ensure latest version..."
            $python_cmd -m pip cache purge 2>/dev/null || true

            # Try --user first (PEP 668 compliant)
            if $python_cmd -m pip install --user --no-cache-dir --upgrade ostruct-cli; then
                log_success "ostruct-cli installed successfully with pip --user"
                install_method="pip-user"
            else
                log_warning "User installation failed. Trying with --break-system-packages..."
                log_warning "WARNING: This bypasses Python environment protection (PEP 668)"
                # Fallback to --break-system-packages for externally-managed environments
                if $python_cmd -m pip install --break-system-packages --no-cache-dir --upgrade ostruct-cli; then
                    log_success "ostruct-cli installed successfully with pip --break-system-packages"
                    install_method="pip-system"
                else
                    log_error "Failed to install ostruct-cli with pip"
                    log_error "Consider using a Python virtual environment or installing via pipx"
                    exit 1
                fi
            fi
        fi
    fi
    echo ""

    # Configure PATH for ostruct
    log_info "Configuring PATH..."
    if [[ "$DRY_RUN" == "true" ]]; then
        log_info "[DRY-RUN] Would configure PATH for ostruct"
        log_success "[DRY-RUN] PATH configuration simulated"
    else
        # Clean up conflicting Python installations
        cleanup_old_python_paths "$python_cmd"

        local bin_dirs_to_add=()

        # Check if installed via pipx
        if command_exists pipx; then
            local pipx_bin_dir="$HOME/.local/bin"
            if [[ -f "$pipx_bin_dir/ostruct" ]]; then
                bin_dirs_to_add+=("$pipx_bin_dir")
                log_info "Found ostruct in pipx directory: $pipx_bin_dir"
            fi
        fi

        # Check Python user bin directory (for pip --user installations)
        local python_user_bin
        if python_user_bin=$(get_python_user_bin "$python_cmd"); then
            if [[ -f "$python_user_bin/ostruct" ]]; then
                bin_dirs_to_add+=("$python_user_bin")
                log_info "Found ostruct in Python user bin: $python_user_bin"
            fi
        fi

        # Add directories to PATH
        for bin_dir in "${bin_dirs_to_add[@]}"; do
            add_to_path "$bin_dir" "$shell_config" "$shell_type"
        done

        if [[ ${#bin_dirs_to_add[@]} -eq 0 ]]; then
            # Check if ostruct is available system-wide (--break-system-packages installation)
            if command_exists ostruct; then
                log_success "ostruct is available system-wide, no PATH configuration needed"
            else
                log_warning "ostruct installation location unknown, may need manual PATH configuration"
            fi
        else
            log_success "PATH configured successfully"
        fi
    fi
    echo ""

    # Test installation and verify version
    log_info "Testing ostruct installation..."
    if [[ "$DRY_RUN" == "true" ]]; then
        log_success "[DRY-RUN] ostruct installation test simulated"
    else
        if command_exists ostruct; then
            local version_output
            local version
            if version_output=$(ostruct --version 2>&1); then
                # Handle multiple version output formats:
                # "ostruct, version 0.8.8" -> "0.8.8"
                # "ostruct-cli 0.8.8" -> "0.8.8"
                # "0.8.8" -> "0.8.8"
                version=$(echo "$version_output" | sed -E 's/.*(version |ostruct-cli |ostruct |^)([0-9]+\.[0-9]+\.[0-9]+).*/\2/')
                if [[ -z "$version" || "$version" == "$version_output" ]]; then
                    log_warning "Could not parse version from: $version_output"
                    version="unknown (parsing failed)"
                fi
            else
                log_warning "Failed to get ostruct version. Output: $version_output"
                version="unknown (command failed)"
            fi
            log_success "ostruct is working! Version: $version"

            # Check if we got the expected version or newer (only if version was parsed successfully)
            if [[ "$version" != "unknown"* ]]; then
                if version_compare "$version" "$EXPECTED_VERSION"; then
                    log_success "âœ… Version $version is current (expected $EXPECTED_VERSION or newer)"
                else
                    log_warning "âš ï¸  Version $version installed (expected $EXPECTED_VERSION or newer)"
                    log_warning "An older version was found. This may lead to unexpected behavior or missing features."
                    log_info "Consider checking for ostruct updates or reinstalling if issues occur."
                fi
            else
                log_info "Skipping version comparison due to parsing failure"
            fi
        else
            log_warning "ostruct command not found in current session"
            log_info "This is normal - the PATH changes take effect in new terminal sessions"
            log_info "Please restart your terminal or run: source $shell_config"
            log_info "Then test with: ostruct --version"

            # Try to find where ostruct was installed for troubleshooting
            local ostruct_locations=()
            for search_dir in "$HOME/.local/bin" "$HOME/Library/Python/*/bin"; do
                if [[ -f "$search_dir/ostruct" ]]; then
                    ostruct_locations+=("$search_dir/ostruct")
                fi
            done

            if [[ ${#ostruct_locations[@]} -gt 0 ]]; then
                log_info "ostruct found at: ${ostruct_locations[*]}"
                if [[ ${#ostruct_locations[@]} -gt 1 ]]; then
                    log_warning "Multiple ostruct installations detected!"
                    log_warning "This may cause conflicts. Consider removing older installations."
                fi
                log_info "If issues persist, try running directly: ${ostruct_locations[0]} --version"
            fi
        fi
    fi
    echo ""

    # Check for and offer to clean up old installations
    if [[ "$DRY_RUN" == "false" ]]; then
        # Determine the current installation path
        local current_install_path=""
        if command_exists ostruct; then
            current_install_path=$(which ostruct 2>/dev/null)
        elif [[ ${#ostruct_locations[@]} -gt 0 ]]; then
            current_install_path="${ostruct_locations[0]}"
        fi

        if [[ -n "$current_install_path" ]]; then
            cleanup_old_installations "$current_install_path" false
        fi
    fi

    # Success message
    echo "ðŸŽ‰ Installation Complete!"
    echo "======================="
    echo ""
    log_success "ostruct has been installed successfully!"
    echo ""
    echo "Next steps:"
    echo "1. Restart your terminal or run: source $shell_config"
    echo "2. Test the installation: ostruct --version"
    echo "3. If you get import errors, ensure you're using the correct Python:"
    echo "   which ostruct  # Should show the path we configured"
    echo "   which python3  # Should match the Python version we installed"
    echo "4. Get help: ostruct --help"
    echo "5. Set up your OpenAI API key:"
    echo "   export OPENAI_API_KEY='your-api-key-here'"
    echo "   # Or create a .env file with: OPENAI_API_KEY=your-api-key-here"
    echo ""
    echo "ðŸ“– Documentation: https://ostruct.readthedocs.io"
    echo "ðŸ› Issues: https://github.com/yaniv-golan/ostruct/issues"
    echo ""
    echo "ðŸ’¡ Tip: If you encounter conflicts with old installations later,"
    echo "   run the cleanup tool: curl -sSL https://github.com/yaniv-golan/ostruct/releases/latest/download/install-macos.sh | bash -s -- --cleanup-only"
    echo ""

    # Show what was installed
    echo "Installed components:"
    if [[ "$DRY_RUN" == "true" ]]; then
        echo "  â€¢ [DRY-RUN] Would show installed components"
    else
        if command_exists brew; then
            echo "  â€¢ Homebrew: $(brew --version | head -1)"
        fi
        echo "  â€¢ Python: $($python_cmd --version)"
        echo "  â€¢ ostruct: $(ostruct --version 2>/dev/null || echo 'installed')"
    fi
    echo ""
}

# Run main function
main "$@"
